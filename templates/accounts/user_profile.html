{% extends "base.html" %}
{% load static %}
{% load i18n %}
{% block content %}
<div class="social-card">
    <div class="social-card-info">
        <h2>{{user}}</h2>
        <p>{{user.first_name}} {{user.last_name}}</p>
            <img class="profile-picture" src='{% if user.profile_picture %}{{user.profile_picture.url}}{% else %}{% static "images/no-profile-picture.jpg" %}{% endif %}' alt=""/>
            {% if user.bio %}<p>{{user.bio}}</p>{% endif %}
        </div>
    <div class="social-card-relations">
        <div class="social-card-followers">
            <a class="link" href="#following"><strong>{{user.following_count}}</strong> {% trans "Following" %}</a>
            <a class="link" href="#followers"><strong>{{user.followers_count}}</strong> {% trans "Followers" %}</a>
    </div>
    {% if not user == request.user %}
    <button class="btn" id="follow" user-id='{{user.id}}' action='{% if user.following_user %}unfollow{% else %}follow{% endif %}'>
        {% if user.following_user %}{% trans "Unfollow" %}{% else %}{% trans "Follow" %}{% endif %}
    </button>
    {% else %}
    <a class="link" href='{% url "accounts:update" request.user.pk %}'>
        <button class="btn">{% trans "Update info" %}</button>
    </a>
    {% endif %}
    <form>
        {% csrf_token %}
    </form>
</div>
<h2>{% trans "likes" %}</h2>
{% if likes %}
<div class="likes-list">
    <ul class="list likes-list">
        {% for shop in likes %}
            <li class="item likes-item">
                <a class="link likes-item-link" href="{{ shop.get_absolute_url }}">{{shop.name}}</a>
            </li>
        {% endfor %}
        <a class="link" href='{% url "accounts:likes" user.pk %}'>
            <button class="btn">{% trans "See all likes" %}</button>
        </a>
{% else %}
    <p>{% trans "This account has not liked any coffee shop" %}</p>
{% endif %}
    </ul>
</div>
{% include "partials/modal.html" with accounts=followers type="followers" %}
{% include "partials/modal.html" with accounts=following type="following" %}
{% endblock %}
{% block footer_scripts %}
<script>
    function getAction() {
        return document.getElementById('follow').getAttribute('action')
    }

    function getUserId() {
        let id = document.getElementById('follow').getAttribute('user-id')
        return parseInt(id)
    }

    function setActionValue(action) {
        document.getElementById('follow').setAttribute('action', action)
    }

    function toggleFollowButton(action){
        // Toggles the solid color and the empty color heart version 
        document.getElementById('follow').textContent = action
        document.getElementById('follow').classList.toggle('followed')
    }
    
    function setDisabled(disabled){
        if(disabled){
            document.getElementById('follow').setAttribute('disabled', disabled)
        }else{
            document.getElementById('follow').removeAttribute('disabled')
        }
    }

    // csrf is provided by Django backend
    const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    let url = '{% url "accounts:follow" %}'
    
    let followingButton = document.getElementById('follow')

    let waitingResponse = false

    followingButton.onclick = async () => {
        if(waitingResponse){
            return
        }
        waitingResponse = true
        setDisabled(true)
        let action = getAction()
        let userId = getUserId()
        let request = new Request(
            url,
            {
                method: 'POST',
                headers: { 
                    'X-CSRFToken': csrftoken,
                    // Backend requires the HTTP request to be made asynchronously
                    'X-Requested-With': 'XMLHttpRequest',
                },
                mode: 'same-origin',
                body: JSON.stringify({ "action": action, "id": userId })
            }
        )
        try {
            const response = await fetch(request)
            const data = await response.json()
            setActionValue(data.action)
            toggleFollowButton(data.action)
            setDisabled(false)
            waitingResponse = false
        } catch (err) {
            console.error(err)
            waitingResponse = false
        }
    }
</script>
{% endblock %}